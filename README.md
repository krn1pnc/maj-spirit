# Maj Spirit

## Dev log

### 20250930

选题．感觉 MiniNginx 有点太魔怔了，什么叫配置文件解析要自己写？工程量太大，遂放弃．OIDC 没学过啊，而且锁 Go，没法写．看 MajSpirit，诶这不是我们 ZJOI 2019 吗，是我喜欢的题目，直接选择．

选型．语言神，启动！简单搜索后发现有个叫 tungstenite 的库可以提供 WebSocket 支持，并且可以和 tokio 一起用．初步想法是用这个处理 WebSocket，用 axum 处理 http．反正没有性能要求，数据库直接用熟悉的 SQLite 了．

### 20251001

早起回老家．路上细细搜索了一下，发现 axum 本身可以处理 WebSocket，底层用的就是 tungstenite．

先花了点时间把用户系统搓了，然后琢磨怎么实现房间功能．这玩意好像不是很好写啊，维护状态还是太邪恶了．

最终决定房间只存在于内存中，对局完成后立刻生成对局 id 再写入数据库，这样对局过程中应该就不存在数据库操作了．

给每个房间单独 spawn 一个 task，应该可以避免操作全局状态？

本来想把登录以外的所有操作都丢 WebSocket 里的，发现写起来太麻烦，于是决定 WebSocket 只传递出牌等游戏状态，加入房间这种操作用 http api 实现．

### 20251002

先初步实现了带 jwt 的 WebSocket 连接，暂时先用 websocat 调试，客户端等实现了房间再说．

然后实现了房间的加入和退出，写的过程中发现用用户名当主键实在不是个好主意，到处都要 `.clone()`，准备改成自增的 `id`．

然后瞎搓了一个 WebSocket 连接管理层，希望它能正常工作！

### 20251003

失败了．用起来寸步难行啊．

找 LLM 严肃学习了一下．发现让客户端消息直接打在游戏实例上，写起来比较舒服．

然后就重写了 WebSocket 连接处理部分，顺便实现了对局开始的 API．

开始搓游戏逻辑，先写胡牌判定．原计划是直接把 [\[ZJOI2019\] 麻将](https://www.luogu.com.cn/problem/P5279) 那题 2091 个节点的自动机糊上去，改程序改一半突然想到跑个自动机最简化会更好．然后自己搓 Hopcroft 无果，遂去题解区偷了个[最小化完的自动机](https://www.luogu.com.cn/article/qfnybrcq)，直接糊上去．

### 20251004

把游戏主逻辑搓好了．虽然感觉写出了很多 bug．

然后发现这规则 7 个对子不算胡的，还得重新打下自动机转移的表．

开始搓客户端．原本想要写个 tui 程序的，发现这东西不是很好写啊，写这个感觉会耽误后续测试时长．故放弃，写了经典的 IO 交互程序来测试．

搓客户端途中修了点参数传错的 bug，果然类型系统很重要，`usize` 满天飞迟早会出事．

现在应该能玩了？拉点人测试．
