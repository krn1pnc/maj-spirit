# Maj Spirit

## Dev log

### 20250930

选题．感觉 MiniNginx 有点太魔怔了，什么叫配置文件解析要自己写？工程量太大，遂放弃．OIDC 没学过啊，而且锁 Go，没法写．看 MajSpirit，诶这不是我们 ZJOI 2019 吗，是我喜欢的题目，直接选择．

选型．语言神，启动！简单搜索后发现有个叫 tungstenite 的库可以提供 WebSocket 支持，并且可以和 tokio 一起用．初步想法是用这个处理 WebSocket，用 axum 处理 http．反正没有性能要求，数据库直接用熟悉的 SQLite 了．

### 20251001

早起回老家．路上细细搜索了一下，发现 axum 本身可以处理 WebSocket，底层用的就是 tungstenite．

先花了点时间把用户系统搓了，然后琢磨怎么实现房间功能．这玩意好像不是很好写啊，维护状态还是太邪恶了．

最终决定房间只存在于内存中，对局完成后立刻生成对局 id 再写入数据库，这样对局过程中应该就不存在数据库操作了．

给每个房间单独 spawn 一个 task，应该可以避免操作全局状态？

本来想把登录以外的所有操作都丢 WebSocket 里的，发现写起来太麻烦，于是决定 WebSocket 只传递出牌等游戏状态，加入房间这种操作用 http api 实现．

### 20251002

先初步实现了带 jwt 的 WebSocket 连接，暂时先用 websocat 调试，客户端等实现了房间再说．

然后实现了房间的加入和退出，写的过程中发现用用户名当主键实在不是个好主意，到处都要 `.clone()`，准备改成自增的 `id`．

然后瞎搓了一个 WebSocket 连接管理层，希望它能正常工作！

### 20251003

失败了．用起来寸步难行啊．

找 LLM 严肃学习了一下．发现让客户端消息直接打在游戏实例上，写起来比较舒服．

然后就重写了 WebSocket 连接处理部分，顺便实现了对局开始的 API．

开始搓游戏逻辑，先写胡牌判定．原计划是直接把 [\[ZJOI2019\] 麻将](https://www.luogu.com.cn/problem/P5279) 那题 2091 个节点的自动机糊上去，改程序改一半突然想到跑个自动机最简化会更好．然后自己搓 Hopcroft 无果，遂去题解区偷了个[最小化完的自动机](https://www.luogu.com.cn/article/qfnybrcq)，直接糊上去．

### 20251004

把游戏主逻辑搓好了．虽然感觉写出了很多 bug．

然后发现这规则 7 个对子不算胡的，还得重新打下自动机转移的表．

开始搓客户端．原本想要写个 tui 程序的，发现这东西不是很好写啊，写这个感觉会耽误后续测试时长．故放弃，写了经典的 IO 交互程序来测试．

搓客户端途中修了点参数传错的 bug，果然类型系统很重要，`usize` 满天飞迟早会出事．

现在应该能玩了？拉点人测试．

### 20251005

白天爽玩去了，晚上回去打磨了下客户端，方便明天测试．

### 20251006

事实证明客户端还是太难用了，拉到的人测一半都跑了．所以我现在还不知道我核心逻辑有没有写挂的地方，可喜可贺．

然后重写了 WebSocket 连接管理部分，感觉像个人样了．无视一堆 `unwrap()` 的话．

然后把摆了的错误处理写了下，感觉还是很难看．

诶我操怎么快验收了，我历史查询还没写呢．然后在晚上思考了下牌局历史咋存数据库．感觉不如一条大 JSON 往里塞．

### 20251007

诶我操怎么又有事，抽了点时间把排名查询写了．具体牌局信息我打算丢个 JSON 回去，让客户端自己算．感觉全对了！

快速搞定了历史查询，唉搓 CRUD 就是爽．

然后把客户端变成了只会出最小牌的 bot，测试了所有功能，查出来了一堆 typo，不过游戏逻辑没有问题！

明天尝试把客户端变得更像人类写出来的东西，然后拉人测试．

### 20251008

给客户端加了代理作战，策略是出手上最小的牌．

然后拉人测试，然后发现不同花色的牌不能凑顺子．成傻逼了，赶紧改了判定．

之后修了一车 bug．您写代码完全不过脑子是吗．

### 20251009

没啥用 WebSocket 的经验，凭感觉写了个断线重连后的状态同步，写起来很诡异，感觉全错了．

测试人员建议用更先进的只使用 ASCII 可见字符的记牌法，不过今天回学校，所以暂时摆了．
